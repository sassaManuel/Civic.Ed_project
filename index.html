<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Mario Physics</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(#5c94fc, #87ceeb);
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 2000px;
            height: 120px;
            background: #8B4513;
        }

        #mario {
            position: absolute;
            width: 40px;
            height: 60px;
            background: red;
            border-radius: 8px;
        }

        .pipe {
            position: absolute;
            width: 80px;
            height: 120px;
            background: green;
            bottom: 120px;
        }

        .pipe::before {
            content: "";
            position: absolute;
            top: -20px;
            left: -10px;
            width: 100px;
            height: 30px;
            background: darkgreen;
        }

        #pipe1 {
            left: 300px;
        }

        #pipe2 {
            left: 550px;
        }

        #pipe3 {
            left: 800px;
        }

        #pipe4 {
            left: 1050px;
        }

        .modal {
            display: none;
            position: fixed;
            width: 100%;
            height: 100%;
            background: white;
            top: 0;
            left: 0;
            z-index: 10;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="mario"></div>

    <div class="pipe" id="pipe1"></div>
    <div class="pipe" id="pipe2"></div>
    <div class="pipe" id="pipe3"></div>
    <div class="pipe" id="pipe4"></div>

    <div class="ground"></div>

    <div class="modal" id="modal">
        <h1>Sei entrato nel tubo!</h1>
        <button onclick="exitPipe()">ESCI</button>
    </div>

    <script>
        const mario = document.getElementById("mario");
        const pipes = document.querySelectorAll(".pipe");
        const modal = document.getElementById("modal");

        let x = 50;
        let y = 0;
        let velocityY = 0;

        const gravity = 0.8;
        const jumpForce = 20; // SALTO PIÙ ALTO
        const speed = 5;
        const groundLevel = 120;

        let keys = {};
        let onGround = true;

        document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
        document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

        function gameLoop() {

            if (modal.style.display !== "flex") {

                let nextX = x;
                let nextY = y;

                // Movimento (WASD + Frecce)
                if (keys["arrowright"] || keys["d"]) nextX += speed;
                if (keys["arrowleft"] || keys["a"]) nextX -= speed;

                // Salto
                if ((keys["arrowup"] || keys["w"]) && onGround) {
                    velocityY = jumpForce;
                    onGround = false;
                }

                // Gravità
                velocityY -= gravity;
                nextY += velocityY;

                if (nextY <= 0) {
                    nextY = 0;
                    velocityY = 0;
                    onGround = true;
                }

                // Aggiorna temporaneamente posizione verticale
                let marioRect = {
                    left: nextX,
                    right: nextX + 40,
                    bottom: groundLevel + nextY,
                    top: groundLevel + nextY + 60
                };

                // Collisioni tubi
                pipes.forEach(pipe => {
                    const rect = pipe.getBoundingClientRect();
                    const pipeLeft = rect.left;
                    const pipeRight = rect.right;
                    const pipeTop = rect.top;
                    const pipeBottom = rect.bottom;

                    const mLeft = marioRect.left;
                    const mRight = marioRect.right;
                    const mTop = window.innerHeight - marioRect.top;
                    const mBottom = window.innerHeight - marioRect.bottom;

                    // Collisione sopra tubo
                    if (
                        mRight > pipeLeft &&
                        mLeft < pipeRight &&
                        mBottom >= pipeTop - 5 &&
                        mBottom <= pipeTop + 20 &&
                        velocityY <= 0
                    ) {
                        nextY = pipeTop - groundLevel - 60;
                        velocityY = 0;
                        onGround = true;
                    }

                    // Collisione laterale
                    if (
                        mTop < pipeBottom &&
                        mBottom > pipeTop
                    ) {
                        if (mRight > pipeLeft && mLeft < pipeLeft && velocityY !== 0) {
                            nextX = pipeLeft - 40;
                        }
                        if (mLeft < pipeRight && mRight > pipeRight && velocityY !== 0) {
                            nextX = pipeRight;
                        }
                    }

                    // Entrata tubo (solo sopra)
                    if (
                        (keys["arrowdown"] || keys["s"]) &&
                        onGround &&
                        mRight > pipeLeft &&
                        mLeft < pipeRight &&
                        mBottom >= pipeTop - 5 &&
                        mBottom <= pipeTop + 20
                    ) {
                        enterPipe();
                    }

                });

                x = nextX;
                y = nextY;

                mario.style.left = x + "px";
                mario.style.bottom = (groundLevel + y) + "px";
            }

            requestAnimationFrame(gameLoop);
        }

        function enterPipe() {
            modal.style.display = "flex";
        }

        function exitPipe() {
            modal.style.display = "none";
        }

        gameLoop();
    </script>

</body>

</html>